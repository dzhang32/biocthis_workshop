---
title: "Developing Bioconductor-friendly packages using biocthis"
author: 
- name: "David Zhang"
  affiliation: UCL
date: "21 November 2020"
output: 
  html_document:
    keep_md: true
---



> Aim: Give overview of principles behind and hands-on practice for developing Bioconductor-friendly packages using biocthis. 

<br><br>

# Outline

1.  Why make R/Bioconductor packages?
2.  What do R packages consist of?
3.  Testing fundamentals. 
4.  How to make Bioconductor-friendly packages using `biocthis`?
5.  Practical run through - making your own `utils` package.

<br><br>

# Why make R/Bioconductor packages?

## R packages

- **Share** functions with others/yourself (with `git`). 
- Improving the **organization** of your functions - e.g. mentality, documentation, continuous updates. 
- Integrated **unit testing** to keep your functions robust to future changes. 

Useful resources:

1. R packages [book](https://rstudio.com/products/rpackages/)
2. [Your first R package in 1 hour](https://www.pipinghotdata.com/posts/2020-10-25-your-first-r-package-in-1-hour/)

## Bioconductor packages

- **Share** code more widely with Bioconductor community. 
- Code review, learning about developing software - forced compliance with Bioconductor standards. 
- More citations - https://www.biorxiv.org/content/10.1101/2020.11.16.385211v1
- CV/reputation points. 

<br><br>

# What do R packages consist of?

## States of R packages 

- The structure of R packages is explained well [here](https://r-pkgs.org/package-structure-state.html).
- 5 states: source, bundles, binary, installed, in-memory


```
## # A tibble: 5 x 2
##   state     description                                                         
##   <chr>     <chr>                                                               
## 1 source    A set files/directories in a set structure. The state you develop w…
## 2 bundles   Source compressed into a single tar.gz (e.g. through devtools::buil…
## 3 binary    Binary version (e.g. distributed by CRAN). Can be generated through…
## 4 installed Either the binary or bundle that's decompressed and placed into you…
## 5 in-memory Load a package into memory using library() or devtools::load_all()
```

## Structure of R packages

R packages have several key components, which are shown in screenshot taken from [here](https://github.com/lcolladotor/biocthis) and detailed below. 

<div class="figure">
<img src="figures/biocthis_package_structure.png" alt="biocthis package structure" width="1848" />
<p class="caption">biocthis package structure</p>
</div>


```
## # A tibble: 8 x 2
##   state       description                                                       
##   <chr>       <chr>                                                             
## 1 .github     The GitHub actions workflow.                                      
## 2 R           Contains all the code for the functions of your package.          
## 3 inst        Additional raw data in the package you would like available to th…
## 4 man         Function documentation generated by Roxygen                       
## 5 tests       Unit tests for functions                                          
## 6 vignettes   vignette description usage of your package                        
## 7 DESCRIPTION Author details, licence, dependencies and general summary of your…
## 8 README      Read me documentation shown at the GitHub repository
```

<br><br>

# Testing fundamentals

3 levels of testing: 

1. **Unit testing** individual functions
2. **R CMD Check or BiocCheck** checks that you're package can be built, installed and complies to R/Bioconductor package guidelines. 
3. Testing across multiple **operating systems** using GHA
    
## Unit testing

- For complicated code, ensures future updates do not break existing functionality.  
- You do this already, just manually. 
- `testhat` automates this for R packages.
- Rule of thumb: If you catch a bug, write a test. 
- Metrics, try to be fast + comprehensive.

## R CMD Check or BiocCheck

- Reports ERROR/WARNINGS/NOTES.
- R CMD Check that your package meets certain criteria: 
    - Runs all unit tests 
    - Have you documented your functions?
    - Have you written a proper DESCRIPTION?
    - Have you used ":::"?
- BiocCheck is more "stringent":
    - Are your functions less than 80 lines?
    - Do >80% have examples?

## Testing across Linux/Mac/Windows

- A great lecture on GHA basics from Jim Hester can be found [here](https://www.jimhester.com/talk/2020-rsc-github-actions/)
- GitHub actions is used in this case for testing, but is very flexible
- On an event, do something
- Written in yet-another-markdown-language (YAML)
- GitHub has "runners" based on Linux/Mac/Windows OS (and permits dockers)
- We run R CMD Check and BioCheck on all 3 to catch OS-specific issues

<br><br>

# How to make Bioconductor-friendly packages using `biocthis`?

## usethis

- [usethis](https://usethis.r-lib.org/) has a lot of functions to enable easy package development. 
- `usethis::create_package()` - creates package skeleton
- `usethis::use_r()` - creates .R function skeleton
- `usethis::use_git()` - connects current package to git. 
- `usethis::use_github()` - create a GitHub repo for current repo. 
- `usethis::use_github_action()` - creates GHA skeleton
- 

## biocthis

- Builds upon `usethis` specifically for Bioconductor packages. 
- 
- Still under active development. 

# Reproducibility


```
## ─ Session info ───────────────────────────────────────────────────────────────────────────────────────────────────────
##  setting  value                       
##  version  R version 4.0.3 (2020-10-10)
##  os       macOS Catalina 10.15.7      
##  system   x86_64, darwin17.0          
##  ui       X11                         
##  language (EN)                        
##  collate  en_GB.UTF-8                 
##  ctype    en_GB.UTF-8                 
##  tz       Europe/London               
##  date     2020-11-21                  
## 
## ─ Packages ───────────────────────────────────────────────────────────────────────────────────────────────────────────
##  package     * version    date       lib source                           
##  assertthat    0.2.1      2019-03-21 [1] CRAN (R 4.0.2)                   
##  backports     1.2.0      2020-11-02 [1] CRAN (R 4.0.3)                   
##  broom         0.7.2      2020-10-20 [1] CRAN (R 4.0.2)                   
##  cellranger    1.1.0      2016-07-27 [1] CRAN (R 4.0.2)                   
##  cli           2.1.0      2020-10-12 [1] CRAN (R 4.0.2)                   
##  colorspace    2.0-0      2020-11-11 [1] CRAN (R 4.0.3)                   
##  crayon        1.3.4      2017-09-16 [1] CRAN (R 4.0.2)                   
##  DBI           1.1.0      2019-12-15 [1] CRAN (R 4.0.2)                   
##  dbplyr        2.0.0      2020-11-03 [1] CRAN (R 4.0.3)                   
##  digest        0.6.27     2020-10-24 [1] CRAN (R 4.0.2)                   
##  dplyr       * 1.0.2      2020-08-18 [1] CRAN (R 4.0.2)                   
##  ellipsis      0.3.1      2020-05-15 [1] CRAN (R 4.0.2)                   
##  evaluate      0.14       2019-05-28 [1] CRAN (R 4.0.1)                   
##  fansi         0.4.1      2020-01-08 [1] CRAN (R 4.0.2)                   
##  forcats     * 0.5.0      2020-03-01 [1] CRAN (R 4.0.2)                   
##  fs            1.5.0      2020-07-31 [1] CRAN (R 4.0.2)                   
##  generics      0.1.0      2020-10-31 [1] CRAN (R 4.0.2)                   
##  ggplot2     * 3.3.2      2020-06-19 [1] CRAN (R 4.0.2)                   
##  glue          1.4.2      2020-08-27 [1] CRAN (R 4.0.2)                   
##  gtable        0.3.0      2019-03-25 [1] CRAN (R 4.0.2)                   
##  haven         2.3.1      2020-06-01 [1] CRAN (R 4.0.2)                   
##  highr         0.8        2019-03-20 [1] CRAN (R 4.0.2)                   
##  hms           0.5.3      2020-01-08 [1] CRAN (R 4.0.2)                   
##  htmltools     0.5.0      2020-06-16 [1] CRAN (R 4.0.2)                   
##  httr          1.4.2      2020-07-20 [1] CRAN (R 4.0.2)                   
##  jsonlite      1.7.1      2020-09-07 [1] CRAN (R 4.0.2)                   
##  knitr       * 1.30       2020-09-22 [1] CRAN (R 4.0.2)                   
##  lifecycle     0.2.0      2020-03-06 [1] CRAN (R 4.0.2)                   
##  lubridate     1.7.9      2020-06-08 [1] CRAN (R 4.0.2)                   
##  magrittr      1.5        2014-11-22 [1] CRAN (R 4.0.2)                   
##  modelr        0.1.8      2020-05-19 [1] CRAN (R 4.0.2)                   
##  munsell       0.5.0      2018-06-12 [1] CRAN (R 4.0.2)                   
##  pillar        1.4.6      2020-07-10 [1] CRAN (R 4.0.2)                   
##  pkgconfig     2.0.3      2019-09-22 [1] CRAN (R 4.0.2)                   
##  png           0.1-7      2013-12-03 [1] CRAN (R 4.0.2)                   
##  purrr       * 0.3.4      2020-04-17 [1] CRAN (R 4.0.2)                   
##  R6            2.5.0      2020-10-28 [1] CRAN (R 4.0.2)                   
##  Rcpp          1.0.5      2020-07-06 [1] CRAN (R 4.0.2)                   
##  readr       * 1.4.0      2020-10-05 [1] CRAN (R 4.0.2)                   
##  readxl        1.3.1      2019-03-13 [1] CRAN (R 4.0.2)                   
##  reprex        0.3.0.9001 2020-11-02 [1] Github (tidyverse/reprex@d3fc4b8)
##  rlang         0.4.8      2020-10-08 [1] CRAN (R 4.0.2)                   
##  rmarkdown     2.5        2020-10-21 [1] CRAN (R 4.0.2)                   
##  rstudioapi    0.12       2020-11-10 [1] CRAN (R 4.0.3)                   
##  rvest         0.3.6      2020-07-25 [1] CRAN (R 4.0.2)                   
##  scales        1.1.1      2020-05-11 [1] CRAN (R 4.0.2)                   
##  sessioninfo * 1.1.1      2018-11-05 [1] CRAN (R 4.0.2)                   
##  stringi       1.5.3      2020-09-09 [1] CRAN (R 4.0.2)                   
##  stringr     * 1.4.0      2019-02-10 [1] CRAN (R 4.0.2)                   
##  tibble      * 3.0.4      2020-10-12 [1] CRAN (R 4.0.2)                   
##  tidyr       * 1.1.2      2020-08-27 [1] CRAN (R 4.0.2)                   
##  tidyselect    1.1.0      2020-05-11 [1] CRAN (R 4.0.2)                   
##  tidyverse   * 1.3.0      2019-11-21 [1] CRAN (R 4.0.2)                   
##  utf8          1.1.4      2018-05-24 [1] CRAN (R 4.0.2)                   
##  vctrs         0.3.4      2020-08-29 [1] CRAN (R 4.0.2)                   
##  withr         2.3.0      2020-09-22 [1] CRAN (R 4.0.2)                   
##  xfun          0.19       2020-10-30 [1] CRAN (R 4.0.2)                   
##  xml2          1.3.2      2020-04-23 [1] CRAN (R 4.0.2)                   
##  yaml          2.2.1      2020-02-01 [1] CRAN (R 4.0.2)                   
## 
## [1] /Library/Frameworks/R.framework/Versions/4.0/Resources/library
```
