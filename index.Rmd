---
title: "Developing Bioconductor-friendly packages using biocthis"
author: 
- name: "David Zhang"
  affiliation: UCL
date: "`r format(Sys.time(), '%d %B %Y')`"
output: 
  html_document:
    df_print: kable
    keep_md: true
---

```{r setup, include = FALSE}

library(knitr)
library(tidyverse)

knitr::opts_chunk$set(echo = FALSE, message = FALSE)

```

> Aim: Give overview of principles behind and hands-on practice for developing Bioconductor-friendly packages using biocthis. 

<br>

# Outline

1.  Why make R/Bioconductor packages?
2.  What do R packages consist of?
3.  Testing fundamentals. 
4.  How to make Bioconductor-friendly packages using `biocthis`?
5.  Practical run through - making your own `utils` package.

<br><br>

# Why make R/Bioconductor packages?

## R packages

- **Share** functions with others/yourself (with `git`). 
- Improving the **organization** of your functions - e.g. mentality, documentation, continuous updates. 
- Integrated **unit testing** to keep your functions robust to future changes. 

Useful resources:

1. R packages [book](https://rstudio.com/products/rpackages/)
2. [Your first R package in 1 hour](https://www.pipinghotdata.com/posts/2020-10-25-your-first-r-package-in-1-hour/)

## Bioconductor packages

- **Share** code more widely with Bioconductor community. 
- Code review, learning about developing software - forced compliance with Bioconductor standards. 
- More citations - https://www.biorxiv.org/content/10.1101/2020.11.16.385211v1
- CV/reputation points. 

<br>

# What do R packages consist of?

## States of R packages 

- The structure of R packages is explained well [here](https://r-pkgs.org/package-structure-state.html).
- 5 states: source, bundles, binary, installed, in-memory

```{r package-states}

tibble(state = 
         c("source", 
           "bundles", 
           "binary", 
           "installed", 
           "in-memory"), 
       description = 
         c("A set files/directories in a set structure. The state you develop with and encounter with when cloning a repo.", 
           "Source compressed into a single tar.gz (e.g. through devtools::build())", 
           "Binary version (e.g. distributed by CRAN). Can be generated through devtools::build(binary = TRUE)", 
           "Either the binary or bundle that's decompressed and placed into your R package library (using install.packages())", 
           "Load a package into memory using library() or devtools::load_all()"))

```

## Structure of R packages

R packages have several key components, which are shown in screenshot taken from [here](https://github.com/lcolladotor/biocthis) and detailed below. 

```{r key-components, fig.cap = "biocthis package structure"}

knitr::include_graphics("figures/biocthis_package_structure.png")

```

```{r key-components-desc}

tibble(file_or_directory = 
         c(".github", 
           "R", 
           "inst", 
           "man", 
           "tests", 
           "vignettes", 
           "DESCRIPTION",
           "README"), 
       description = 
         c("The GitHub actions workflow.", 
           "Contains all the code for the functions of your package.", 
           "Additional raw data in the package you would like available to the user.", 
           "Function documentation generated by Roxygen", 
           "Unit tests for functions", 
           "vignette description usage of your package", 
           "Author details, licence, dependencies and general summary of your package", 
           "Read me documentation shown at the GitHub repository"))

```

<br>

# Testing fundamentals

3 levels of testing: 

1. **Unit testing** individual functions
2. **R CMD Check or BiocCheck** checks that you're package can be built, installed and complies to R/Bioconductor package guidelines. 
3. Testing across multiple **operating systems** using GHA
    
## Unit testing

- For complicated code, ensures future updates do not break existing functionality.  
- You do this already, just manually. 
- `testhat` automates this for R packages.
- Rule of thumb: If you catch a bug, write a test. 
- Metrics, try to be fast + comprehensive.

## R CMD Check or BiocCheck

- Reports ERROR/WARNINGS/NOTES.
- R CMD Check that your package meets certain criteria: 
    - Runs all unit tests 
    - Have you documented your functions?
    - Have you written a proper DESCRIPTION?
    - Have you used ":::"?
- BiocCheck is more "stringent":
    - Are your functions less than 80 lines?
    - Do >80% have examples?

## Testing across Linux/Mac/Windows

- A great lecture on GHA basics from Jim Hester can be found [here](https://www.jimhester.com/talk/2020-rsc-github-actions/)
- GitHub actions is used in this case for testing, but is very flexible
- On an event, do something
- Written in yet-another-markdown-language (YAML)
- GitHub has "runners" based on Linux/Mac/Windows OS (and permits dockers)
- We run R CMD Check and BioCheck on all 3 to catch OS-specific issues

<br><br>

# How to make Bioconductor-friendly packages using `biocthis`?

## usethis

- [usethis](https://usethis.r-lib.org/) has a lot of functions to enable easy package development. 
- `usethis::create_package()` - creates package skeleton
- `usethis::use_r()` - creates .R function skeleton
- `usethis::use_git()` - connects current package to git. 
- `usethis::use_github()` - create a GitHub repo for current repo. 
- `usethis::use_github_action()` - creates GHA skeleton


## biocthis

- Builds upon `usethis` specifically for Bioconductor packages. 
- 
- Still under active development. 

# Reproducibility

```{r reproducibility, echo = FALSE}

# Session info
library("sessioninfo")

options(width = 120)

session_info()
```
